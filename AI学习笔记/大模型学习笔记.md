# å¤§æ¨¡å‹å­¦ä¹ ç¬”è®°

## 1ã€ä½¿ç”¨langchainç®€å•è°ƒç”¨llm

```pyton
from langchain_openai import ChatOpenAI
from langchain_core.output_parsers import StrOutputParser
from langchain.prompts.chat import ChatPromptTemplate, ChatPromptValue
from langchain_community.utilities import SearchApiAPIWrapper
from langchain_core.tools import Tool

if __name__ == "__main__":
    
    # æ¨¡å‹
    llm = ChatOpenAI(
        temperature=0.0,
        api_key='sk-0EXfWLim00ftiVLDVwMmotZOgSPi0aphLqXSBxefeIhoh44y',
        base_url='https://api.chatanywhere.tech',
        streaming=True
        )

    # æ¨¡æ¿
    chat_prompt = ChatPromptTemplate.from_messages([
        ("system", "ä½ æ˜¯ä¸€åèŠå¤©åŠ©æ‰‹ï¼Œä½ çš„åå­—å«é˜¿giao,æ¯æ¬¡å¼€å¤´éƒ½è¦ä»¥`ä¸€giaoæˆ‘ç±»giaoå¼€å¤´`ï¼Œå¹¶ä¸”æ—¶ä¸æ—¶çš„è¯´ä¸€å¥`ç«èŠ±`"),
        ("human", "{text}"),
    ])

    # è¾“å‡ºè§£æå™¨
    output_parser = StrOutputParser()

    
    # ç®¡é“
    chain = chat_prompt | llm | output_parser  # ä¸‰é˜¶æ®µç®¡é“

    # while True:
    #     # ç›´æ¥ä¼ é€’ç”¨æˆ·è¾“å…¥å­—å…¸ï¼ˆè‡ªåŠ¨è§¦å‘æ¨¡æ¿æ¸²æŸ“ï¼‰
    #     print(chain.invoke({"text":  input("è¯·è¾“å…¥:")}))
    
    while True:
        user_input = input("\nè¯·è¾“å…¥:")
        print("é˜¿giaoï¼š", end="", flush=True)  # ğŸŒŸ æµå¼è¾“å‡ºå‰ç½®ç¬¦ 
        
        # ğŸŒŸ æµå¼å“åº”æ ¸å¿ƒä»£ç  
        for chunk in chain.stream({"text":  user_input}):
            print(chunk, end="", flush=True)  # é€å—è¾“å‡º 
        print()  # æ¢è¡Œåˆ†éš” 
```

## 2ã€æ–‡æ¡£åŠ è½½å™¨

```
# from langchain_community.document_loaders.csv_loader import CSVLoader

# ä»csvæ–‡ä»¶ä¸­åŠ è½½æ–‡ä»¶
# loader = CSVLoader('./file/random_data.csv', encoding='utf-8')
# data = loader.load()
# print(data)


# ä»ç›®å½•ä¸­åŠ è½½æ–‡æ¡£
from langchain_community.document_loaders import DirectoryLoader
loader = DirectoryLoader("./file")
docs = loader.load()
print(docs)

```



## 3ã€embedding(åµŒå…¥)

### 1ã€embedding APiè°ƒç”¨

```
from langchain_openai import OpenAIEmbeddings

#  ChatOpenAI(
#         temperature=0.0,
#         api_key='sk-0EXfWLim00ftiVLDVwMmotZOgSPi0aphLqXSBxefeIhoh44y',
#         base_url='https://api.chatanywhere.tech',
#         streaming=True
#         )

embeddings = OpenAIEmbeddings(
                                model="text-embedding-3-large", 
                                api_key="sk-0EXfWLim00ftiVLDVwMmotZOgSPi0aphLqXSBxefeIhoh44y",
                                base_url='https://api.chatanywhere.tech'
                            )

aa = embeddings.embed_query("Hello, world!")
bb = embeddings.embed_query("""æœ¬æ–‡å…±4ä¸‡å­—ï¼Œå»ºè®®æ”¶è—é˜…è¯»
æœ¬æ–‡ä¸»è¦ä¸ºå½“å‰å¤§æ¨¡å‹é¢†åŸŸçƒ­é—¨ç ”ç©¶æ–¹å‘ï¼ˆå¦‚æ–‡ç”Ÿå›¾ã€æ–‡ç”Ÿè§†é¢‘ã€æ–‡ç”ŸéŸ³ä¹ç­‰ï¼‰çš„çƒ­é—¨è®ºæ–‡ã€‚å¸Œæœ›èƒ½å¤Ÿä¸ºå¤§å®¶æä¾›è¾ƒä¸ºå…¨é¢çš„å¤§æ¨¡å‹æœ€æ–°ç ”ç©¶è¿›å±•ã€‚å½“ç„¶ï¼Œç›®å‰è¿˜æ— æ³•æ¶µç›–æ‰€æœ‰çƒ­é—¨è®ºæ–‡ä»¥åŠç ”ç©¶æ–¹å‘ï¼Œæœ›è¯·è§è°…ã€‚
ä»¥ä¸‹ï¼Œä¸º2024å¹´2æœˆä»½æ”¶å½•çš„ä¸€äº›çƒ­é—¨å¤§æ¨¡å‹ç ”ç©¶è®ºæ–‡ã€‚æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œå…±è®¡4ä¸‡å­—ï¼Œå»ºè®®æ”¶è—ï½"""
)


print(len(aa))
print(len(bb))
```

### 2ã€å°†è¯å‘é‡å­˜å‚¨åˆ°redisä¸­

```
# ä»csvä¸­åŠ è½½å†…å®¹
from langchain_community.document_loaders.csv_loader import CSVLoader
from langchain_openai import OpenAIEmbeddings
from langchain_community.vectorstores import Redis

loader = CSVLoader('./file/random_data.csv', encoding='utf-8')
documents = loader.load()

# è°ƒç”¨åˆ†è¯apiå°†åˆ†è¯åçš„å†…å®¹ä¿å­˜åˆ°redisä¸­


embeddings = OpenAIEmbeddings(
                                model="text-embedding-3-large", 
                                api_key="sk-0EXfWLim00ftiVLDVwMmotZOgSPi0aphLqXSBxefeIhoh44y",
                                base_url='https://api.chatanywhere.tech'
                            )

# 3. è¿æ¥åˆ°Redisï¼ˆè¯·ä¿®æ”¹ä¸ºæ‚¨çš„é…ç½®ï¼‰
REDIS_URL = "redis://localhost:6379"

# 4. å°†æ–‡æ¡£å­˜å…¥Rediså‘é‡æ•°æ®åº“
vectorstore = Redis.from_documents(
    documents=documents,
    embedding=embeddings,
    redis_url=REDIS_URL,
    index_name="csv_data",
    index_schema={
        "text": [{"name": "content"}],

        "vector": [{"name": "content_vector", "dims": 3072, "algorithm": "HNSW"}]
    }
)

print("æ•°æ®æˆåŠŸå­˜å…¥Redisï¼Œç´¢å¼•åç§°ï¼š", vectorstore.index_name)



# if __name__ == "__main__":
#     # æŸ¥è¯¢æµ‹è¯•
#     results = vectorstore.similarity_search("é™ˆç§€è‹±", k=3)
#     print("ç›¸ä¼¼ç»“æœï¼š", results)
```

## 4ã€åŸºäºredisè¯å‘é‡æ•°æ®åº“çš„ç®€å•èŠå¤©æœºå™¨äºº

```

from langchain_openai import OpenAIEmbeddings, ChatOpenAI
from langchain_community.vectorstores import Redis
from langchain.chains import RetrievalQA
from langchain.prompts import PromptTemplate


# åˆå§‹åŒ–embeddingæ¨¡å‹ï¼ˆéœ€è¦ä¸å­˜å‚¨æ—¶ä¸€è‡´ï¼‰
embeddings = OpenAIEmbeddings(
    model="text-embedding-3-large",
    api_key="sk-0EXfWLim00ftiVLDVwMmotZOgSPi0aphLqXSBxefeIhoh44y",
    base_url='https://api.chatanywhere.tech'
)


# åˆå§‹åŒ–å¤§è¯­è¨€æ¨¡å‹
llm = ChatOpenAI(
        temperature=0.0,
        api_key='sk-0EXfWLim00ftiVLDVwMmotZOgSPi0aphLqXSBxefeIhoh44y',
        base_url='https://api.chatanywhere.tech',
        streaming=True
        )

# Redisè¿æ¥é…ç½®ï¼ˆéœ€ä¸å­˜å‚¨æ—¶ä¸€è‡´ï¼‰
REDIS_URL = "redis://localhost:6379"
INDEX_NAME = "csv_data"

# è¿æ¥åˆ°å·²å­˜åœ¨çš„Rediså‘é‡åº“
vectorstore = Redis(
    redis_url=REDIS_URL,
    index_name=INDEX_NAME,
    embedding=embeddings
)

# è‡ªå®šä¹‰æç¤ºæ¨¡æ¿
PROMPT_TEMPLATE = """è¯·æ ¹æ®ä»¥ä¸‹ä¸Šä¸‹æ–‡ä¿¡æ¯å›ç­”é—®é¢˜ã€‚
å¦‚æœä½ ä¸çŸ¥é“ç­”æ¡ˆæˆ–ä¸Šä¸‹æ–‡ä¿¡æ¯ä¸è¶³ï¼Œè¯·å¦‚å®å›ç­”ä½ ä¸çŸ¥é“ã€‚
ä¸Šä¸‹æ–‡ï¼š{context}
é—®é¢˜ï¼š{question}
è¯·ç”¨ä¸­æ–‡æä¾›æ¸…æ™°ã€ç®€æ´çš„å›ç­”ï¼š"""


# åˆ›å»ºæ£€ç´¢å¢å¼ºç”Ÿæˆé“¾
qa_chain = RetrievalQA.from_chain_type(
    llm=llm,
    chain_type="stuff",
    retriever=vectorstore.as_retriever(search_kwargs={"k": 3}),
    chain_type_kwargs={
        "prompt": PromptTemplate(
            template=PROMPT_TEMPLATE,
            input_variables=["context", "question"]
        )
    },
    return_source_documents=True
)

def chat_interface():
    print("æ•°æ®åº“èŠå¤©æœºå™¨äººå·²å¯åŠ¨ï¼è¾“å…¥'exit'é€€å‡º")
    while True:
        query = input("\nä½ çš„é—®é¢˜ï¼š")
        if query.lower() == "exit":
            print("å†è§ï¼")
            break
        
        try:
            # æ‰§è¡ŒæŸ¥è¯¢
            result = qa_chain.invoke({"query": query})
            
            # æ˜¾ç¤ºå›ç­”
            print("\nå›ç­”ï¼š", result["result"])
            
                
        except Exception as e:
            print("å‡ºé”™äº†ï¼Œè¯·ç¨åå†è¯•ã€‚é”™è¯¯ä¿¡æ¯ï¼š", str(e))
            
            
if __name__ == "__main__":
    # # ç›¸ä¼¼åº¦æŸ¥è¯¢æµ‹è¯•
    # query = "ç§€è‹±çš„ä¿¡æ¯æ˜¯ä»€ä¹ˆ"
    # results = vectorstore.similarity_search(query, k=5)
    
    # print(f"ä¸'{query}'ç›¸ä¼¼çš„ç»“æœï¼š")
    # for i, doc in enumerate(results):
    #     print(f"\nç»“æœ {i+1}:")
    #     print(f"å†…å®¹: {doc.page_content}")
    #     print(f"å…ƒæ•°æ®: {doc.metadata}")
    chat_interface()
```

